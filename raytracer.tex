\documentclass{standalone}
\usepackage{color}
\usepackage{pgffor}
\usepackage{xfp}

\newcommand{\dimension}{1pt}
\newcommand{\pixel}[1]{\color[RGB]{#1}{\rule{\dimension}{\dimension}}}

\newcommand{\aspectratio}{\fpeval{16.0 / 9.0}}
\newcommand{\width}{100}
\newcommand{\height}{\fpeval{floor(\width / \aspectratio)}}

\newcommand{\viewportheight}{2.0}
\newcommand{\viewportwidth}{\fpeval{\aspectratio * \viewportheight}}
\newcommand{\focal}{1.0}

\newcommand{\origin}{(0,0,0)}
\newcommand{\horizontal}{(\viewportwidth,0,0)}
\newcommand{\vertical}{(0,\viewportheight,0)}

% TODO: do not hard-code
\newcommand{\lowerleftcorner}{(-1.7,-1.0,-1.0)}

% 3D unpacking
%% #1 = x, #2 = y, #3 = z
\def\getx(#1,#2,#3){#1}
\def\gety(#1,#2,#3){#2}
\def\getz(#1,#2,#3){#3}

% Vector functions
% (#1) = vector, (#2) = other vector, #2 = scalar
\def\vlength(#1){\fpeval{sqrt(\getx(#1) * \getx(#1) + \gety(#1) * \gety(#1) + \getz(#1) * \getz(#1))}}
\def\vadd(#1)(#2){(\fpeval{\getx(#1) + \getx(#2)},\fpeval{\gety(#1) + \gety(#2)},\fpeval{\getz(#1) + \getz(#2)})}
\def\vsub(#1)(#2){(\fpeval{\getx(#1) - \getx(#2)},\fpeval{\gety(#1) - \gety(#2)},\fpeval{\getz(#1) - \getz(#2)})}
\def\vmulscalar(#1)#2{(\fpeval{\getx(#1) * #2},\fpeval{\gety(#1) * #2},\fpeval{\getz(#1) * #2})}
\def\vdivscalar(#1)#2{(\fpeval{\getx(#1) / #2},\fpeval{\gety(#1) / #2},\fpeval{\getz(#1) / #2})}
\def\vunit(#1){\expandafter{\vdivscalar(#1){\vlength(#1)}}}

% #1 = point
\def\createpixel(#1){%
    \edef\u{\fpeval{\getx(#1)/(\width - 1)}}%
    \edef\v{\fpeval{\gety(#1)/(\height - 1)}}%

    \edef\uh{\fpeval{\expandafter\vmulscalar\horizontal\u}}%
    \edef\vv{\fpeval{\expandafter\vmulscalar\vertical\v}}%

    \edef\vsumi{\lowerleftcorner\uh}%
    \edef\vsumi{\fpeval{\expandafter\vadd\vsumi}}%
    \edef\vsumii{\vsumi\vv}%
    \edef\vsumii{\fpeval{\expandafter\vadd\vsumii}}%
    \edef\vsumiii{\vsumii\origin}%
    \edef\raydir{\fpeval{\expandafter\vsub\vsumiii}}%

    % TODO: split this into another macro with proper expansion
    % raycolor(origin,raydir)
    \edef\unitdir{\fpeval{\expandafter\vunit\raydir}}%
    \edef\y{\fpeval{\expandafter\gety\unitdir}}%
    \edef\t{\fpeval{0.5 * \y + 1.0}}%
    \edef\mt{\fpeval{1.0 - \t}}%
    \edef\va{\fpeval{\vmulscalar(1.0,1.0,1.0)\mt}}%
    \edef\vb{\fpeval{\vmulscalar(0.5,0.7,1.0)\t}}%
    % TODO: remove this tmp macro (why cannot expandafter without it? :/)
    \edef\vtmp{\va\vb}%
    \edef\ray{\fpeval{\expandafter\vadd\vtmp}}%

    \pixel{%
        \fpeval{floor(255.0 * \expandafter\getx\ray)},
        \fpeval{floor(255.0 * \expandafter\gety\ray)},
        \fpeval{floor(255.0 * \expandafter\getz\ray)}
    }
}

\begin{document}

\unitlength=\dimension
\begin{picture}(\width,\height)
    \foreach \x in {0,...,\inteval{\width - 1}}{%
        \foreach \y in {0,...,\inteval{\height - 1}}{%
            \put(\x,\y){\createpixel(\x,\y,0)}
        }
    }
\end{picture}

\end{document}
