\documentclass{standalone}
\usepackage{color}
\usepackage{pgffor}
\usepackage{xfp}

\newcommand{\dimension}{1pt}
\newcommand{\pixel}[1]{\color[RGB]{#1}{\rule{\dimension}{\dimension}}}

\newcommand{\infinity}{2147483647} % 2^31-1

\input{scene}

% Global variables to detect ray hit on sphere
\newcounter{hitsphere}
\def\closestsphere{\infinity}
\def\hitspherecolor{(0,0,0)}

% 3D unpacking
%% #1 = x, #2 = y, #3 = z
\def\getx(#1,#2,#3){#1}
\def\gety(#1,#2,#3){#2}
\def\getz(#1,#2,#3){#3}

% Sphere unpacking
%% (#1) = (x, y, z), (#2) = radius, (#3) = (r, g, b) colors
\def\getspherecoords(#1)(#2)(#3){(#1)}
\def\getsphereradius(#1)(#2)(#3){#2}
\def\getspherecolors(#1)(#2)(#3){(#3)}

% (#1) = point
\def\torgbpixel(#1){%
    \pixel{%
        \fpeval{floor(255.0 * \getx(#1))},
        \fpeval{floor(255.0 * \gety(#1))},
        \fpeval{floor(255.0 * \getz(#1))}
    }%
}

% Vector functions
% (#1) = vector, (#2) = other vector, #2 = scalar
\def\vlength(#1){\fpeval{sqrt(\getx(#1) * \getx(#1) + \gety(#1) * \gety(#1) + \getz(#1) * \getz(#1))}}
\def\vadd(#1)(#2){(\fpeval{\getx(#1) + \getx(#2)},\fpeval{\gety(#1) + \gety(#2)},\fpeval{\getz(#1) + \getz(#2)})}
\def\vsub(#1)(#2){(\fpeval{\getx(#1) - \getx(#2)},\fpeval{\gety(#1) - \gety(#2)},\fpeval{\getz(#1) - \getz(#2)})}
\def\vmulscalar(#1)#2{(\fpeval{\getx(#1) * #2},\fpeval{\gety(#1) * #2},\fpeval{\getz(#1) * #2})}
\def\vdivscalar(#1)#2{(\fpeval{\getx(#1) / #2},\fpeval{\gety(#1) / #2},\fpeval{\getz(#1) / #2})}
\def\vunit(#1){\expandafter{\vdivscalar(#1){\vlength(#1)}}}
\def\vdot(#1)(#2){\fpeval{\getx(#1)*\getx(#2)+\gety(#1)*\gety(#2)+\getz(#1)*\getz(#2)}}

% #1 = ray origin (point), #2 = ray dir (vec), #3 = sphere center (point),
% #4 = sphere radius, #5 = sphere color (rgb)
\def\hitspherediscriminant(#1)(#2)(#3)#4#5{%
    \edef\v{\fpeval{\vsub(#1)(#3)}}%
    \edef\a{\fpeval{\vdot(#2)(#2)}}%
    \edef\b{\fpeval{2.0 * \expandafter\vdot\v(#2)}}%
    \edef\vv{\v\v}%
    \edef\c{\fpeval{\expandafter\vdot\vv - #4*#4}}%
    \edef\discriminant{\fpeval{\b*\b - 4.0*\a*\c}}%
    \ifnum\fpeval{\discriminant>0}=1%
        \edef\dist{\fpeval{%
            min((-\b-sqrt(\discriminant))/(2.0*\a), (-\b+sqrt(\discriminant))/(2.0*\a))
        }}%
        \ifnum\fpeval{\dist>0}=1%
            \setcounter{hitsphere}{1}%
            % Choose the closest sphere to the camera
            \ifnum\fpeval{\dist<\closestsphere}=1%
                \global\edef\closestsphere{\dist}%
                \global\edef\hitspherecolor{#5}%
            \fi%
        \fi%
    \fi%
}

% #1 = ray origin (point), #2 = ray dir (vect), #3 = macro continuation
\def\raycolor(#1)(#2)#3{%
    \setcounter{hitsphere}{0}%
    \global\edef\closestsphere{\infinity}%
    \foreach \sphere in \world {%
        \edef\param{%
            \noexpand(#1)\noexpand(#2)%
            \expandafter\getspherecoords\sphere%
            {\expandafter\getsphereradius\sphere}%
            {\expandafter\getspherecolors\sphere}%
        }%
        \expandafter\hitspherediscriminant\param%
    }%
    \ifnum\value{hitsphere}=1%
        \expandafter#3\hitspherecolor%
    \else%
        \edef\unitdir{\fpeval{\vunit(#2)}}%
        \edef\y{\fpeval{\expandafter\gety\unitdir}}%
        \edef\t{\fpeval{0.5 * \y + 1.0}}%
        \edef\mt{\fpeval{1.0 - \t}}%
        \edef\va{\fpeval{\vmulscalar(1.0,1.0,1.0)\mt}}%
        \edef\vb{\fpeval{\vmulscalar(0.5,0.7,1.0)\t}}%
        % TODO: remove this tmp macro (why cannot expandafter without it? :/)
        \edef\vtmp{\va\vb}%
        \edef\ray{\fpeval{\expandafter\vadd\vtmp}}%
        \expandafter#3\ray%
    \fi%
}

% #1 = point
\def\createpixel(#1){%
    \edef\u{\fpeval{\getx(#1)/(\width - 1)}}%
    \edef\v{\fpeval{\gety(#1)/(\height - 1)}}%

    \edef\uh{\fpeval{\expandafter\vmulscalar\horizontal\u}}%
    \edef\vv{\fpeval{\expandafter\vmulscalar\vertical\v}}%

    \edef\vsumi{\lowerleftcorner\uh}%
    \edef\vsumi{\fpeval{\expandafter\vadd\vsumi}}%
    \edef\vsumii{\vsumi\vv}%
    \edef\vsumii{\fpeval{\expandafter\vadd\vsumii}}%
    \edef\vsumiii{\vsumii\origin}%
    \edef\raydir{\fpeval{\expandafter\vsub\vsumiii}}%

    \edef\rtmp{\origin\raydir}%
    \expandafter\raycolor\rtmp\torgbpixel%
}

\begin{document}

\unitlength=\dimension
\begin{picture}(\width,\height)
    \foreach \x in {0,...,\inteval{\width - 1}}{%
        \foreach \y in {0,...,\inteval{\height - 1}}{%
            \put(\x,\y){\createpixel(\x,\y,0)}%
        }
    }
\end{picture}

\end{document}
